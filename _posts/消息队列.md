---
title: 消息队列
categories:
  - 笔记
tags:
  - 消息队列
date: 2018-10-07 20:28:45
---
参考地址:https://juejin.im/entry/578b3fe98ac2470060906d5d
 <!-- more -->

## 什么是消息队列


## 如何解决消息重复
### 版本号
1. 发送端每次发送的消息都带上一个版本号,接收端只接受比当前版本号大的消息
2. 为了防止乱序,每次只处理版本号大1的消息,版本号差大于1的消息先存起来

### 状态机
使用版本号有一个问题就是最大值问题,而且要求消息带有版本号,接收方还要保存期望版本号到来之前的所有消息,成本很高
1. 接收方维护一个状态机,规定当前状态下可以接受并处理的消息的状态,不符合状态的要么是重复,要么是乱序,要求发送方过一段时间重发,并限制次数,防止死循环

### 尽量减少消息重复产生
1. broker记录messageId,直到投递成功清除,重复到来的messageId不做处理,这样只要发送方在清除周期内能够感知到消息处理成功,就基本不会再server端产生重复消息
2. 对于server投递到consumer的消息,记录下投递的ip,重发之前询问ip消息处理是否成功,无果在重发


### push模型和pull模型
1. push模型
优点:
即时性高,broker一有消息就能想consumer推送
缺点:
慢消费,如果消费者消费的速度比发送者的发送的速度慢很多,势必造成broker的消息堆积
2. pull模型
优点:
consumer可以按需消费，不用担心自己处理不了的消息来骚扰自己，而broker堆积消息也会相对简单，无需记录每一个要发送消息的状态，只需要维护所有消息的队列和偏移量就可以了。所以对于建立索引等慢消费，消息量有限且到来的速度不均匀的情况，pull模式比较合适。
缺点:
consumer无法准确判断什么时候应该去pull消息

